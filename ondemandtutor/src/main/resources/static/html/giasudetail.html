<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="../assets/css/giasudetail.css">
    <link rel="stylesheet" href="../assets/css/header.css">
    <link rel="stylesheet" href="../assets/css/footer.css">
    <link rel="stylesheet" href="../asset/fonts/fontawesome-free-6.5.2-web/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <title>Document</title>

</head>
<body>
<header class="header">
    <!--test-->
    <div class="logo-container">
        <a class="img-logo" href="../html/home.html">
            <!-- <img class="logo" src="../assets/img/logo/snapedit_17228353747082.png" alt=""> -->
            <p class="text">LEARN TOgetHER</p>
        </a>
    </div>

    <div class="navbar-container">
        <a class="nav-box" href="../html/gioithieu.html">GIỚI THIỆU</a>
        <a class="nav-box" href="./tutor.html">GIA SƯ</a>
        <a class="nav-box" href="./dichvulist.html">DỊCH VỤ</a>
        <a class="nav-box hidden" href="./taodichvu.html">TẠO DỊCH VỤ</a>
    </div>

    <div class="login-search-container">
        <div class="message-container" id="messageContainer">
            <a href="messages.html" class="message-link">
                <i class="message-icon fa-regular fa-message"></i>
            </a>
        </div>

        <div class="login-container">
            <a href="modal.html" class="search-link">
                <button id="loginButton" class="login-button">Đăng nhập</button>
            </a>
            <div class="user-info" id="userInfo">
                <span id="usernameDisplay"></span>
                <img id="avatar" src="https://th.bing.com/th/id/OIP.MaDrjtmPQGzKiLHrHEPfFAHaHa?w=199&h=199&c=7&r=0&o=5&pid=1.7" alt="Avatar" class="avatar">
                <div id="userDropdown" class="user-dropdown">
                    <a href="editprofile.html" class="sub-menu-link">
                        <img src="../assets/img/header/profile.png" alt="">
                        <p>Thông tin cá nhân</p>
                        <i class="fa-solid fa-chevron-right"></i>
                    </a>
                    <a href="#" id="logoutButton" class="sub-menu-link">
                        <img src="../assets/img/header/logout.png" alt="">
                        <p>Đăng xuất</p>
                        <i class="fa-solid fa-chevron-right"></i>
                    </a>
                </div>
            </div>
        </div>
    </div>
</header>

<div class="tutor-container">
    <div class="rating-hire-price-container">
        <div class="tutor-video">
            <iframe class="videoo" width="300" height="200" src="https://www.youtube.com/embed/bg6wwEJ-HjA?start=12" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>


        </div>

        <div class="tutor-button">
            <button class="nut">yêu cầu thuê</button>
            <a href=""><button class="nut">gửi tin nhắn</button></a>
        </div>

    </div>
    <div class="container-div">

        <div class="avatar-name-contaier">
            <img id="avatar-a" class="avatar-a" src="https://resources.churchofchrist1830.org/wp-content/uploads/2024/02/generic-bio-avatar.png" alt="">
            <div class="name-tutor">
                <h4> <span id="tutorName"></span> </h4>
                <p id="subjectId">monhoc</p>

            </div>
        </div>

        <div class="about-service-container">
            <h1 >Mô tả</h1>
            <div id="bio" class="thongtin"><p>thong tin</p></div>
        </div>
      
        <div class="write-comment">
            <div class="rating">
                <input type="radio" name="rating" id="star5" value="5">
                <label for="star5" title="5 stars">&#9733;</label>
                <input type="radio" name="rating" id="star4" value="4">
                <label for="star4" title="4 stars">&#9733;</label>
                <input type="radio" name="rating" id="star3" value="3">
                <label for="star3" title="3 stars">&#9733;</label>
                <input type="radio" name="rating" id="star2" value="2">
                <label for="star2" title="2 stars">&#9733;</label>
                <input type="radio" name="rating" id="star1" value="1">
                <label for="star1" title="1 star">&#9733;</label>
            </div>

            <div class="but-con">
            <input type="text" id="respone" name="priceOfSession" value="" placeholder="viết phản hồi...">
            <button id="sendReviewButton" class="send-button" ><i class="fas fa-paper-plane"></i>
            </button>
        </div>
        </div>
        <div id="reviewContainer"  class="reviews-container">
        <div   class="respone-tutor-container">

            <div class="comment-user">
                <div class="user-info">
                    <div class="user-avar">
                        <img src="https://resources.churchofchrist1830.org/wp-content/uploads/2024/02/generic-bio-avatar.png" >
                    </div>
                    <div class="user-name">
                        <strong>name</strong>
                        <span>date</span>
                    </div>

                </div>
                <div class="rating">
                    <span data-rating="5">★</span>
                    <span data-rating="4">★</span>
                    <span data-rating="3">★</span>
                    <span data-rating="2">★</span>
                    <span data-rating="1">★</span>
                </div>

            </div>

            <div class="client-comment">
                <p>Oh great, I just started learning web programming languages. So lucky to know your channel. Hopefully in the future you can create many useful videos like this for everyone learning programming </p>
            </div>
        </div>
        </div>
    </div>
</div>
<!--<footer>-->
<!--    <div class="footer-container">-->
<!--        <div class="socials">-->
<!--            <a href=""><i class="fa-brands fa-facebook"></i></a>-->
<!--            <a href=""><i class="fa-brands fa-instagram"></i></a>-->
<!--            <a href=""><i class="fa-brands fa-twitter"></i></a>-->
<!--            <a href=""><i class="fa-brands fa-google-plus"></i></a>-->
<!--            <a href=""><i class="fa-brands fa-youtube"></i></a>-->
<!--        </div>-->
<!--        <div class="footer-nav">-->
<!--            <ul>-->
<!--                <li><a href="">Home</a></li>-->
<!--                <li><a href="">About</a></li>-->
<!--                <li><a href="">Contact Us</a></li>-->
<!--            </ul>-->
<!--        </div>-->
<!--    </div>-->
<!--    <div class="footer-bottom">-->
<!--        <p>Copyright &copy;2024; Designed by <span class="designer">DL</span></p>-->
<!--    </div>-->

<!--</footer>-->

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const token = localStorage.getItem('token');

        console.log(token); // Check if the token exists and is correct

        const urlParams = new URLSearchParams(window.location.search);
        const tutorId = urlParams.get('id');  // Get the ID from the URL

        if (tutorId) {
            fetch(`http://localhost:8080/v1/tutor-services/tutor/${tutorId}`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'

                }
            })
                .then(response => response.json())
                .then(data => {
                    console.log('API Response:', data);  // Check if the response structure is as expected

                    const uniqueSubjects = new Set();

                    // Assuming `data` is an array of subjects
                    data.result.forEach(item => {
                        if (item.nameSubject) {
                            uniqueSubjects.add(item.nameSubject);
                        }
                    });

                    // Convert the Set to an array and join the subjects into a single string
                    const subjectsArray = Array.from(uniqueSubjects);
                    const subjectsText = subjectsArray.join(', ');
                    // document.querySelector('#subjectId').innerHTML = `${data.result[i].nameSubject}` || '';
                    document.querySelector('#subjectId').innerHTML = subjectsText || 'No subjects available';





                })
                .catch(error => console.error('Error fetching tutor details:', error));

        }

        displayVideo(tutorId);




    });

</script>
<script>
    function displayVideo(tutorId) {
        fetch(`http://localhost:8080/v1/videos/tutor/${tutorId}`, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`,
                'Content-Type': 'application/json'
            }
        })
            .then(response => response.json())
            .then(data => {
                console.log(data);

                const tutorCard = document.querySelector(`.rating-hire-price-container`);
                const iframe = tutorCard.querySelector('.tutor-video iframe');

                // Xử lý dữ liệu video từ API
                if (data.data ) {

                    console.log("data",data.data.videoUrl)
                    const videoUrl =data.data.videoUrl; // Lấy URL video

                    // Kiểm tra nếu videoUrl hợp lệ
                    if (videoUrl) {
                        iframe.src = videoUrl; // Cập nhật URL video vào iframe
                    } else {
                        // Nếu videoUrl là null hoặc không hợp lệ, hiển thị ảnh thay thế
                        iframe.src = 'https://www.youtube.com/embed/4CCGI83vOVo?si=FLQFqYNCQUNql7pk';
                    }

                } else {
                    // Nếu không có video, hiển thị ảnh thay thế
                    iframe.src = 'https://www.youtube.com/embed/4CCGI83vOVo?si=FLQFqYNCQUNql7pk';
                }
            })
            .catch(error => {
                console.error('Error fetching video:', error);
                // Nếu có lỗi khi fetch, cũng hiển thị ảnh thay thế
                const tutorCard = document.querySelector(`.rating-hire-price-container[data-tutor-id="${tutorId}"]`);
                const iframe = tutorCard.querySelector('.tutor-video iframe');
                iframe.src = 'https://png.pngtree.com/element_origin_min_pic/17/08/27/4af706394b2927cb119d6ada9683dc52.png';
            });
    }
</script>
<script>
    async function getMyInfo() {
        try {
            const token = localStorage.getItem('token');
            const urlParams = new URLSearchParams(window.location.search);
            const tutorId = urlParams.get('id');

            {
                const response = await fetch(`http://localhost:8080/v1/tutor/${tutorId}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();
                console.log("logggg",data);
                // Cập nhật thông tin cá nhân lên giao diện
                document.querySelector('#tutorName').innerHTML = `${data.result.name}` || '';
                document.querySelector('#bio').innerHTML = `${data.result.bio}` || '';

                const profilePicElement = document.getElementById('avatar-a');


                if (data.result.imgUrl) { // Kiểm tra nếu có URL của hình đại diện
                    profilePicElement.src = data.result.imgUrl;
                } else {
                    profilePicElement.src = 'https://th.bing.com/th/id/OIP.MaDrjtmPQGzKiLHrHEPfFAHaHa?w=199&h=199&c=7&r=0&o=5&pid=1.7';
                }
            }



        } catch (error) {
            console.error('There was a problem with the fetch operation:', error);
        }



    }

    // Gọi hàm getMyInfo khi trang được tải
    window.onload = getMyInfo;
</script>
<script>


    document.querySelector('.nut').addEventListener('click', function () {
        const tutorId = new URLSearchParams(window.location.search).get('id');
        if (tutorId) {
            window.location.href = `tutorservice.html?tutorId=${tutorId}`;
        } else {
            window.location.href = 'tutorservice.html';
        }
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const token = localStorage.getItem('token');
        const studentId = localStorage.getItem('id');
        const urlParams = new URLSearchParams(window.location.search);
        const tutorId = urlParams.get('id');

        if (tutorId) {
            // Kiểm tra xem học sinh có đặt khóa học với gia sư này không
            fetch('http://localhost:8080/v1/booking/getBooking', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify({
                    studentId: studentId,
                    tutorId: tutorId
                })
            })
                .then(response => response.json())
                .then(hasBooking => {
                    console.log('Booking check response:', hasBooking);
                    console.log('Booking check response:', hasBooking.id);
                    if (hasBooking && hasBooking.id) {
                        // Hiển thị phần viết đánh giá nếu có booking
                        document.querySelector('.write-comment').style.display = 'block';

                        // Thêm sự kiện cho nút gửi đánh giá
                        const sendButton = document.getElementById('sendReviewButton');
                        if (sendButton) {
                            sendButton.addEventListener('click', function (event) {
                                event.preventDefault(); // Ngăn trang reload lại sau khi nhấn nút

                                // Lấy giá trị của rating
                                const ratingElement = document.querySelector('input[name="rating"]:checked');
                                const rating = ratingElement ? ratingElement.value : 0;

                                // Lấy nội dung phản hồi từ trường nhập liệu
                                const responseElement = document.getElementById('respone');
                                const reviewText = responseElement ? responseElement.value.trim() : '';

                                // Kiểm tra nếu người dùng đã nhập đánh giá hoặc nội dung phản hồi
                                if (!reviewText || rating == 0) {
                                    alert("Vui lòng nhập đánh giá và nội dung phản hồi.");
                                    return;
                                }

                                // Lấy thời gian hiện tại
                                const createdAt = new Date().toISOString(); // ISO format cho timestamp
                                // Dữ liệu cần gửi lên server
                                const reviewData = {
                                    rating: rating,               // Đánh giá sao
                                    comment: reviewText,          // Nội dung comment
                                    tutorId: tutorId,            // ID của gia sư
                                    studentId: studentId,        // ID của học sinh
                                    bookingId: hasBooking.id, // ID của booking (nếu có)
                                    createdAt: createdAt         // Thời gian tạo comment
                                };
                                console.log('Review data:', reviewData);

                                // Gửi yêu cầu POST đến server với dữ liệu review
                                fetch('http://localhost:8080/v1/review/create', {
                                    method: 'POST',
                                    headers: {
                                        'Content-Type': 'application/json',
                                        'Authorization': `Bearer ${token}` // Gửi token xác thực
                                    },
                                    body: JSON.stringify(reviewData) // Dữ liệu cần gửi
                                })
                                    .then(response => response.json())
                                    .then(data => {
                                        console.log('Review sent successfully:', data);
                                        if (data.status === 'success') {
                                            alert('Đánh giá đã được gửi thành công!');
                                            // Xóa nội dung sau khi gửi
                                            if (responseElement) {
                                                responseElement.value = '';
                                            }
                                            // Bỏ chọn rating sau khi gửi
                                            if (ratingElement) {
                                                ratingElement.checked = false;
                                            }
                                        } else {
                                            alert('Đã xảy ra lỗi khi gửi đánh giá: ' + data.message);
                                        }
                                    })
                                    .catch(error => {
                                        console.error('Error sending review:', error);
                                        alert('Đã xảy ra lỗi khi gửi đánh giá.');
                                    });
                            });
                        } else {
                            console.error('Nút sendReviewButton không tồn tại.');
                        }
                    } else {
                        // Ẩn phần viết đánh giá nếu không có booking
                        document.querySelector('.write-comment').style.display = 'none';
                        alert('Bạn phải đặt khóa học với giảng viên này để có thể bình luận.');
                    }
                })
                .catch(error => {
                    console.error('Error checking booking:', error);
                    // alert('Đã xảy ra lỗi khi kiểm tra booking.');
                    document.querySelector('.write-comment').style.display = 'none';
                });
        } else {
            console.error('Tutor ID is missing.');
            alert('ID gia sư không được tìm thấy.');
        }
    });
// ------------------------
    document.addEventListener('DOMContentLoaded', () => {
        const urlParams = new URLSearchParams(window.location.search);
        const tutorId = urlParams.get('id');
        const reviewContainer = document.getElementById('reviewContainer');

        if (!reviewContainer) {
            console.error('reviewContainer is not defined or not found in the DOM.');
            return;
        }

        fetch(`http://localhost:8080/v1/review/tutor/reviews/${tutorId}`)
            .then(response => response.json())
            .then(reviews => {
                if (Array.isArray(reviews)) {
                    if (reviews.length === 0) {
                        reviewContainer.innerHTML = '<p>No reviews available.</p>';
                    } else {
                        displayReviews(reviews);
                    }
                } else {
                    console.error('Invalid response format:', reviews);
                }
            })
            .catch(error => {
                console.error('Error fetching reviews:', error);
            });

        function displayReviews(reviews) {
            reviewContainer.innerHTML = ''; // Clear previous content if needed
            reviews.forEach(review => {
                const reviewHTML = `
        <div class="respone-tutor-container">
            <div class="comment-user">
                <div class="user-info">
                    <div class="user-avar">
                        <img src="https://resources.churchofchrist1830.org/wp-content/uploads/2024/02/generic-bio-avatar.png">
                    </div>
                    <div class="user-name">
                        <strong>${review.name}</strong>
                        <span>${new Date(review.createdAt).toLocaleDateString()}</span>
                    </div>
                </div>
                <div class="rating">
                    ${generateRatingHTML(review.rating)}
                </div>
            </div>

            <div class="client-comment">
                <p>${review.comment}</p>
            </div>
            </div>
            `;

                reviewContainer.innerHTML += reviewHTML;
            });
        }

        function generateRatingHTML(rating) {
            let starsHTML = '';
            for (let i = 5; i >= 1; i--) {
                starsHTML += `<span data-rating="${i}" ${i <= rating ? 'style="color: gold;"' : ''}>★</span>`;
            }
            return starsHTML;
        }
    });

</script>
<script src="../js/header.js"></script>
</body>
</html>
